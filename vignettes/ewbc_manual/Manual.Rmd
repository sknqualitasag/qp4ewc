---
title: "Manual pre-process EWBC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qp4ewc)
```

# Aim

In this vignette, you will get more information about the construction of the main-function `pre_process_ew_input()`. The task of this function is to pre-process the input-parameter-files of ECOWEIGHT for beef cattle (EWBC).

# Parameters

The parameters needed are:

```{r}
# Sire breed can be: AN,AU,CH,LM,OB,SI corresponding to Angus,Aubrac, Charolais, Limousin, Original-Braunvieh, Simmental
s_sirebreed <- "AN"
# Dam breed can be for beef-on-beef: AN,AU,CH,LM,OB,SI corresponding to Angus,Aubrac, Charolais, Limousin, Original-Braunvieh, Simmental 
s_dambreed <- "AN"
# Production system according to ECOWEIGHT for beef-on-beef: 1,2,3 corresponding to purebreeding, crossbreeding, terminal crossing
s_prodsystew <- "1"
# Marketing channel can be: Natura-Beef, SwissPrimBeef
s_marketingchannel <- "Natura-Beef"
# Path to define from the working directory
s_path_directory2create <- file.path(here::here(),"inst","extdata","ewbc","Ecoweight_output")
# Path to input from the literature research. Based on this example an other file can be created with different input-value and input-source.
s_input_file_literature <- file.path(here::here(),"inst","extdata","ewbc","input_literature.txt")
# Path to input from the parameter specific for the scenario. Based on this example an other file can be created with different input-value.
s_input_file_par <- file.path(here::here(),"inst","extdata","ewbc","input_par_statement.txt")
# path to file with input for file 35 for the input-parameter-file for ECOWEIGHT
s_input_file_35 <- file.path(here::here(),"inst","extdata","ewbc","input35_statement.txt")
# path to file with input for file 36 for the input-parameter-file for ECOWEIGHT
s_input_file_36 <- file.path(here::here(),"inst","extdata","ewbc","input36_statement.txt")
# Path to specific input for ProdSyst1 for tested bulls
s_input_file_testedbulls <- file.path(here::here(),"inst","extdata","ewbc","input_testedbulls.txt")
# Path to specific input for ProdSyst3 for replacement progeny heifers
s_input_file_purchasedreplacementheifers  <- file.path(here::here(),"inst","extdata","ewbc","input_purchasedreplacementheifers.txt")
# Path to input from the calving. Based on this example an other file can be created with different input-values.
s_input_file_calving_statement <- file.path(here::here(),"inst","extdata","ewbc","input_calving_statement.txt")
# Path to calving data file
s_input_file_calving <- file.path(here::here(),"inst","extdata","ewbc","test","test_zws_muku_gal.csv")
# Date YYYYMMDD used as start date to filter data for calving or carcass
s_start_date <- 20160101
# Date YYYYMMDD used as end date to filter data for calving or carcass
s_end_date <- 20211231
# Path to input from the progeny flp data. Based on this example an other file can be created with different input-values.
s_input_file_progeny_flp_statement <- file.path(here::here(),"inst","extdata","ewbc","input_flp_statement.txt")
# Path to flp data file
s_input_file_flp <- file.path(here::here(),"inst","extdata","ewbc","test","test_zws_muku_flp.csv")
# Path to calf price data file
s_input_file_calf <- file.path(here::here(),"inst","extdata","ewdc","test","test_calf_data.csv")
# Path to input statement for carcass and price
s_input_file_flp_carcass_matrix_statement <- file.path(here::here(),"inst","extdata","ewbc","input_flp_carcass_matrix_statement.txt")
# Path to input with cow price. Based on this example an other file can be created with different input-values.
s_input_file_price_cow <- file.path(here::here(),"inst","extdata","ewbc","cow_price.txt")
# Path to input with bull price. Based on this example an other file can be created with different input-values.
s_input_file_price_bull <- file.path(here::here(),"inst","extdata","ewbc","bull_price.txt")
# Path to input with heifer price. Based on this example an other file can be created with different input-values.ONLY REQUIRED BEEF ON DAIRY (will not be used for beef on beef)
s_input_file_price_heifer <- file.path(here::here(),"inst","extdata","ewbc","heifer_price.txt")
# Path to input with calf price. Based on this example an other file can be created with different input-values.
s_input_file_price_calf <- file.path(here::here(),"inst","extdata","ewdc","veal_price.txt")
# Path to pedigree input file
s_input_file_ped <- file.path(here::here(),"inst","extdata","ewbc","test","test_pedigree.txt")
# Flag to set to TRUE, if a log-file is whished
b_log <- TRUE
```

# Logfile

At the beginning of the function depending of the setting for `pb_log` and `plogger`, a log-file will be created.

# Major steps of pre_process_ew_input() are

 1) function `create_directory_scenario()` : create directory per scenario with input-parameter-file for ECOWEIGHT. Details in the vignette Explain the function create_directory_scenario().
 
 2) Read file with input from literature research and update input-parameter-file coming from literature of ECOWEIGHT. Details in the vignette Explain the part only from literature. Next to the literature some initial parameter need to be set for EWBC. Further depending of the 
 * `s_sirebreed` some values for average price per breeding bull purchased for natural mating or maturity type of progeny, 
 * `s_prodsystew` some values for production system or mating type for heifers and cows or tested bulls or purchased replacement heifers.
 
 3) function `pre_process_ew_input_calving()` : Pre-processing the calving data for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ew_input_calving().
 
 4) function `pre_process_ewbc_input_progeny_data_flp()` : Pre-processing the progeny data flp for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ewbc_input_progeny_data_flp(). 
 
 5) function `pre_process_ew_input_carcass_data_flp()` : Pre-processing the carcass conformation, fat, prices based on flp-data for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ew_input_carcass_data_flp().

# Run pre_process_ew_input() in RStudio

```{r, warning=FALSE, message=FALSE}
pre_process_ew_input(ps_sirebreed = s_sirebreed,
                       ps_dambreed = s_dambreed,
                       ps_prodsystew = s_prodsystew,
                       ps_marketchannel = s_marketingchannel,
                       ps_path_directory2create = s_path_directory2create,
                       ps_input_file_literature = s_input_file_literature,
                       ps_input_file_par = s_input_file_par,
                       ps_input_file_35 = s_input_file_35,
                       ps_input_file_36 = s_input_file_36,
                       ps_input_file_testedbulls = s_input_file_testedbulls,
                       ps_input_file_purchasedreplacementheifers = s_input_file_purchasedreplacementheifers,
                       ps_input_file_calving_statement = s_input_file_calving_statement,
                       ps_input_file_calving = s_input_file_calving,
                       ps_start_date = s_start_date,
                       ps_end_date = s_end_date,
                       ps_input_file_progeny_flp_statement = s_input_file_progeny_flp_statement,
                       ps_input_file_flp = s_input_file_flp,
                       ps_input_file_calf = s_input_file_calf,
                       ps_input_file_flp_carcass_matrix_statement = s_input_file_flp_carcass_matrix_statement,
                       ps_input_file_price_cow = s_input_file_price_cow,
                       ps_input_file_price_bull = s_input_file_price_bull,
                       ps_input_file_price_heifer = s_input_file_price_heifer,
                       ps_input_file_price_calf = s_input_file_price_calf,
                       ps_input_file_ped = s_input_file_ped,
                       pb_log = b_log)
```

Because we are did test-data-set, it is possible that some values of the INPUTXX.TXT files get NAs.

# Post-processing steps

```{r}
#Path to results files of ewbc
path_results_files <- file.path(here::here(),"inst", "extdata", "ewbc", "Ecoweight_output")
# Path to output statements from the results file of ewdc
s_output_statement <-  file.path(here::here(),"inst", "extdata", "ewbc", "output_statement.txt")
# Path to search patterns needed to find correct results 
s_output_search_pattern <- file.path(here::here(),"inst", "extdata", "ewbc", "output_searchpattern.txt")
# Path to save table of result 
s_path_tbl_save <- file.path(here::here(),"inst", "extdata", "ewbc", "results")
# Path to genetic standard deviation values 
s_input_genetic_SD <- file.path(here::here(),"inst", "extdata", "ewbc", "input_geneticSD.txt")
# Name of results file from ewdc
s_results_name <- "test"
# Calving data used for the calculation of calving score during pre_processing
s_input_file_calving <- file.path("/qualstorzws01/data_projekte/projekte/beef-production-model/2022/test_pipeline/data/zws_muku_gal.csv")
# Date YYYMMDD used as start date to filter for calving score 
s_start_date <- 20160101
# Date YYYYMMDD used as end date to filter data for calving score
s_end_date <- 20211231
# Flag to set to TRUE, if a log-file is whished
b_log <- TRUE
```

Step 1 post processing reads data from the results files and makes single tables per scenario.

```{r, warning=FALSE, message=FALSE}
  results_files <- data.frame(filename = list.files(paste0(path_results_files,"/")))

for(idx in 1:nrow(results_files)){
  s_path_2outputfile <- paste0(path_results_files,"/",results_files[idx,],"/",s_results_name)
  s_scenario <- results_files[idx,]
  scenario_split <- unlist(strsplit(s_scenario, split = "_", fixed = TRUE))
  s_sirebreed <- scenario_split[1]
  s_dambreed <- scenario_split[2]
post_process_ewbc_output(ps_path_2outputfile = s_path_2outputfile,
                         ps_output_statement = s_output_statement,
                         ps_output_search_pattern = s_output_search_pattern,
                         ps_scenario = s_scenario,
                         ps_sirebreed = s_sirebreed,
                         ps_dambreed = s_dambreed,
                         ps_path_tbl_save = s_path_tbl_save,
                         pb_log = b_log)
}
```

Step 2 post processing combines the single scenario tables into tables sorted by the defined criteria for s_sort_by

sort by sire breed
```{r}
# How you want the tables to be organised. one table per sire breed (sire_breed), one table per dam breed (dam_breed) or one table per production system (production_system)
s_sort_by = "sire_breed"
# Path to the results tables printed from the post_processing_ewdc_output function above
s_path_results_tbl <-  file.path(here::here(),"inst", "extdata", "ewbc", "results")
# Where to save the tables of results: this can be the same or different to the directory for the results saved from the initial post processing 
s_path_save <-   file.path(here::here(),"inst", "extdata", "ewbc", "results")

create_table_results_ewbc(ps_sort_by = s_sort_by,
 ps_path_results_tbl = s_path_results_tbl,
 ps_path_save = s_path_save,
pb_log = b_log)

```

sort by dam breed
```{r}
# How you want the tables to be organised. one table per sire breed (sire_breed), one table per dam breed (dam_breed) or one table per production system (production_system)
s_sort_by = "dam_breed"
# Path to the results tables printed from the post_processing_ewdc_output function above
s_path_results_tbl <-  file.path(here::here(),"inst", "extdata", "ewbc", "results")
# Where to save the tables of results: this can be the same or different to the directory for the results saved from the initial post processing 
s_path_save <-   file.path(here::here(),"inst", "extdata", "ewbc", "results")

create_table_results_ewbc(ps_sort_by = s_sort_by,
 ps_path_results_tbl = s_path_results_tbl,
 ps_path_save = s_path_save,
pb_log = b_log)

```

sort by production system 
```{r}
# How you want the tables to be organised. one table per sire breed (sire_breed), one table per dam breed (dam_breed) or one table per production system (production_system)
s_sort_by = "production_system"
# Path to the results tables printed from the post_processing_ewdc_output function above
s_path_results_tbl <-  file.path(here::here(),"inst", "extdata", "ewbc", "results")
# Where to save the tables of results: this can be the same or different to the directory for the results saved from the initial post processing 
s_path_save <-   file.path(here::here(),"inst", "extdata", "ewbc", "results")

create_table_results_ewbc(ps_sort_by = s_sort_by,
 ps_path_results_tbl = s_path_results_tbl,
 ps_path_save = s_path_save,
pb_log = b_log)
```

