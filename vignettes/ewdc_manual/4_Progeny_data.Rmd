---
title: "Explain the function pre_process_ewdc_input_progeny_data_flp()"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Explain the function pre_process_ewdc_input_progeny_data_flp()}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qp4ewc)
```

# Aim

In this vignette, you will get more information about the construction of the function `pre_process_ewdc_input_progeny_data_flp()`. The task of this function is to pre-process the progeny data flp (by calculating mean birth weight, mean live weight at slaughter, slaughter age) to update the input-parameter-file of ECOWEIGHT for beef-on-dairy production system.

# Parameters

The parameters needed are:

```{r, echo = TRUE}
# Sire breed can be: AN,AU,CH,LM,OB,SI corresponding to Angus,Aubrac, Charolais, Limousin, Original-Braunvieh, Simmental
s_sirebreed <- "LM"
# Dam breed can be for beef-on-dairy: HO,BS corresponding to Holstein or Brown Swiss (+Braunvieh) 
s_dambreed <- "HO"
# Production system according to ECOWEIGHT: 4 corresponding to dairy
s_prodsystew <- "4"
# Marketing channel can be: ConventionalBeef, ConventionalVeal
s_marketingchannel <- "ConventionalBeef"
# Path to define from the working directory
s_path_directory2create <- file.path(here::here(),"inst","extdata","ewdc")
# Path to input from the progeny flp data. Based on this example an other file can be created with different input-values.
s_input_file_progeny_flp_statement <- file.path(here::here(),"inst","extdata","ewdc","input_flp_statement.txt")
# Path to flp data file #### !!!! Making specific test file for beef-on-dairy
s_input_file_flp <- file.path(here::here(),"inst","extdata","ewdc","test","test_zws_muku_flp.csv")
# Date YYYYMMDD used as start date to filter data for carcass
s_start_flp_date <- 20160101
# Date YYYYMMDD used as end date to filter data for carcass
s_end_flp_date <- 20211231
# Path to pedigree input file #### !!!! Making specific test file for beef-on-dairy
s_input_file_ped <- file.path(here::here(),"inst","extdata","ewdc","test","test_pedigree.txt")
# Flag to set to TRUE, if a log-file is whished
b_log <- TRUE
```

# Logfile

At the beginning of the function depending of the setting for `pb_log` and `plogger`, a log-file will be created.

# Statements

To update the ECOWEIGHT input-parameter-files, we need to know the statement as well as the INPUT{n}.TXT (where n represent the number of the input file. This n can be between 01 and 36). The statement is in the second column whereas the input-file is in the first column.

```{r, warning=FALSE, message=FALSE}
tbl_input_statement_flp <- read_file_input(ps_input_file = s_input_file_progeny_flp_statement,
                                           pb_log = b_log)
# Head of the statements to update
tbl_input_statement_flp
```

# Constants

```{r, warning=FALSE, message=FALSE}
### # Get the constants
l_constants_progeny_beefOndairy <- get_constants_progeny_beefOndairy()
```

# flp data

In the flp-data-file are the carcass and progeny data readed. With the `s_start_flp_date` and `s_end_flp_date` , the time frame of the flp-data to consider is set. 

```{r, warning=FALSE, message=FALSE}
tbl_flp <- read_file_input_flp(ps_input_file_flp = s_input_file_flp,
                               ps_start_flp_date = s_start_flp_date,
                               ps_end_flp_date = s_end_flp_date,
                               pb_log = b_log)
# Head of flp-data-file
tbl_flp
```

The pedigree is needed to get the breed of the sire and the dam, so that we can know if we are looking to purebred beef, purebred dairy or crossbred. The pedigree informations will be merged with the flp-data-file.

```{r, warning=FALSE, message=FALSE}
### # Read pedigree file
tbl_ped <- read_file_input_ped(ps_input_file_ped = s_input_file_ped,
                               pb_log = b_log)


### # Merge progeny-flp data and pedigree files
tbl_merged_data <- tbl_flp %>% dplyr::inner_join(tbl_ped, by = c("NakoTVD" = "TVDid"))
### # Create different tibble if purebred or crossbred
tbl_purebred_beef <- tbl_merged_data %>% dplyr::filter(Vater_RasseCode == s_sirebreed) %>% dplyr::filter(Mutter_RasseCode == s_sirebreed)
tbl_purebred_dairy <- tbl_merged_data %>% dplyr::filter(Vater_RasseCode == s_dambreed) %>% dplyr::filter(Mutter_RasseCode == s_dambreed)
tbl_crossbred <- tbl_merged_data %>% dplyr::filter(Vater_RasseCode == s_sirebreed) %>% dplyr::filter(Mutter_RasseCode == s_dambreed)
```

# Different situation depending on the marketingchannel

In the dairy system the marketing channel considered are: conventional fattening system for beef and for calf.
Here we will look to the case of conventional fattening system for beef. 

## Calculate mean birth weight for female and male

```{r, warning=FALSE, message=FALSE}
# mean birth weight for female
female_bw_puredairy <- calculate_mean_birthweight(ps_input_flp_tibble = tbl_purebred_dairy,
                                                  ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                                  ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                  ps_prodsystew = s_prodsystew,
                                                  pb_log = b_log)
female_bw_cross <- calculate_mean_birthweight(ps_input_flp_tibble = tbl_crossbred,
                                              ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                              ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                              ps_prodsystew = s_prodsystew,
                                              pb_log = b_log)
# mean birth weight for male in Natura-Beef
male_bw_puredairy <- calculate_mean_birthweight(ps_input_flp_tibble = tbl_purebred_dairy,
                                                ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                                ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                ps_prodsystew = s_prodsystew,
                                                pb_log = b_log)
male_bw_cross <- calculate_mean_birthweight(ps_input_flp_tibble = tbl_crossbred,
                                            ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                            ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                            ps_prodsystew = s_prodsystew,
                                            pb_log = b_log)

```

## Calculate mean live weight at slaughter for female and male

```{r, warning=FALSE, message=FALSE}
# mean live weight at slaughter for female
livewt_slaughter_f_purebeef <- calculate_mean_liveweight_slaughter(ps_input_flp_tibble = tbl_purebred_beef,
                                                                   ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                                                   ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                                   ps_prodsystew = s_prodsystew,
                                                                   pb_log = b_log)
livewt_slaughter_f_puredairy <- calculate_mean_liveweight_slaughter(ps_input_flp_tibble = tbl_purebred_dairy,
                                                                   ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                                                   ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                                   ps_prodsystew = s_prodsystew,
                                                                   pb_log = b_log)
# mean live weight at slaughter for male
livewt_slaughter_m_purebeef <- calculate_mean_liveweight_slaughter(ps_input_flp_tibble = tbl_purebred_beef,
                                                                   ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                                                   ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                                   ps_prodsystew = s_prodsystew,
                                                                   pb_log = b_log)

livewt_slaughter_m_puredairy <- calculate_mean_liveweight_slaughter(ps_input_flp_tibble = tbl_purebred_dairy,
                                                                    ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                                                    ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                                    ps_prodsystew = s_prodsystew,
                                                                    pb_log = b_log)
```

##  Calculate slaughter age for female and male

```{r, warning=FALSE, message=FALSE}
# mean slaughter ag for female
slaughterage_f_purebeef <- calculate_mean_slaughterage(ps_input_flp_tibble = tbl_purebred_beef,
                                                       ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                                       ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                       ps_prodsystew = s_prodsystew,
                                                       pb_log = b_log)
slaughterage_f_puredairy <- calculate_mean_slaughterage(ps_input_flp_tibble = tbl_purebred_dairy,
                                                        ps_sex = l_constants_progeny_beefOndairy$sex_female,
                                                        ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                        ps_prodsystew = s_prodsystew,
                                                        pb_log = b_log)
# mean slaughter ag for male
slaughterage_m_purebeef <- calculate_mean_slaughterage(ps_input_flp_tibble = tbl_purebred_beef,
                                                       ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                                       ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                       ps_prodsystew = s_prodsystew,
                                                       pb_log = b_log)
slaughterage_m_puredairy <- calculate_mean_slaughterage(ps_input_flp_tibble = tbl_purebred_dairy,
                                                        ps_sex = l_constants_progeny_beefOndairy$sex_male,
                                                        ps_marketing_channel = l_constants_progeny_beefOndairy$conv_fattening_beef,
                                                        ps_prodsystew = s_prodsystew,
                                                        pb_log = b_log)
```

# Calculating cow weight after second calving

```{r}
second_calving_wt <- calculate_cow_liveweight(ps_input_flp_tibble = tbl_progeny_data_flp,
                                              ps_second_calvingweight = TRUE,
                                              pb_log = b_log)
```

# Calculate mature cow weight

```{r}
mature_weight_cow <- calculate_cow_liveweight(ps_input_flp_tibble = tbl_progeny_data_flp,
                                              ps_second_calvingweight = FALSE,
                                              pb_log = b_log)
```

