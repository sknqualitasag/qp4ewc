---
title: "Post process EWDC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Post process EWDC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qp4ewc)
```

# Aim

In this vignette, you will get more information about the different steps within `post_process_ewdc_output` where it task is to extract from the result file of ECOWEIGHT specific for dairy cattle economic weights and population means for a specific scenario and produce a pdf as well as csv.



# Parameters 

```{r}
# Sire breed can be: AN,AU,CH,LM,OB,SI corresponding to Angus,Aubrac, Charolais, Limousin, Original-Braunvieh, Simmental
s_sirebreed <- "LM"
# Dam breed can be for beef-on-dairy: HO,BS corresponding to Holstein or Brown Swiss (+Braunvieh) 
s_dambreed <- "HO"
# Production system according to ECOWEIGHT for beef-on-dairy: 4 corresponding to dairy
s_prodsystew <- "4"
# Marketing channel can be: ConventionalBeef, ConventionalVeal, Export corresponding to intensive fattening system for beef or veal or all crossbred calves being sold as calves to the handler
s_marketingchannel <- "ConventionalBeef"
# Path to define from the working directory for beef-on-dairy
s_path_directory2create <- file.path(here::here(),"inst","extdata","ewdc","test","Ecoweight_output")
# Flag to set to TRUE, if a log-file is whished
b_log <- TRUE
#Path to file
s_path_2outputfile <- system.file("extdata","ewdc","Ecoweight_output",
                                  paste0(s_sirebreed,"_",s_dambreed, "_",s_prodsystew,"_",s_marketingchannel,"_test",collapse = ""),
                                  "test",package = "qp4ewc")
# Path to output statements from the results file of ewdc
s_output_statement <-  system.file("extdata","ewdc","output_statement.txt", package = "qp4ewc")
# Path to search patterns needed to find correct results 
s_output_search_pattern <- system.file("extdata","ewdc","output_searchpattern.txt", package = "qp4ewc")
# Path to genetic standard deviation values 
s_input_genetic_SD <- system.file("extdata","ewdc","input_geneticSD.txt", package = "qp4ewc")
# Scenario
s_scenario <- paste0(s_sirebreed,"_",s_dambreed, "_",s_prodsystew,"_",s_marketingchannel,"_test",collapse = "")
# Path to save table of result 
s_path_extracted_results <- file.path(here::here(),"inst", "extdata", "ewdc", "results")
```

Extract economic weights from the output-parameter-file of ECOWEIGHT beef on dairy

```{r, warning=FALSE, message=FALSE}
tbl_result_ew <- extract_ewdc(ps_path_2outputfile = s_path_2outputfile,
                              ps_output_statement = s_output_statement,
                              ps_output_search_pattern = s_output_search_pattern,
                              ps_sirebreed = s_sirebreed,
                              ps_dambreed = s_dambreed,
                              ps_prodsystew = s_prodsystew,
                              ps_marketchannel = s_marketingchannel,
                              ps_path_directory2create = s_path_directory2create,
                              pb_log = b_log)
```

Extract or calculate population mean from the output-parameter-file of ECOWEIGHT beef on dairy

```{r, warning=FALSE}
tbl_result_popmean <- extract_popmean_ewdc(ps_path_2outputfile = s_path_2outputfile,
                                           ps_output_statement = s_output_statement,
                                           ps_output_search_pattern = s_output_search_pattern,
                                           ps_sirebreed = s_sirebreed,
                                           ps_dambreed = s_dambreed,
                                           ps_prodsystew = s_prodsystew,
                                           ps_marketchannel = s_marketingchannel,
                                           ps_path_directory2create = s_path_directory2create,
                                           pb_log = b_log)
```

Combination of the results from the output-parameter-file of ECOWEIGHT beef on dairy

```{r, warning=FALSE}
tbl_aggregate_results <- combine_popmean_ewdc(ptbl_popmean_results = tbl_result_popmean,
                                              ptbl_EW_results = tbl_result_ew,
                                              ps_scenario = s_scenario,
                                              pb_log = b_log)
```

Save table and piechart in pdf

```{r, warning=FALSE}
save_csv_table_piechart_ewdc(ps_tbl_aggregate_results = tbl_aggregate_results,
                             ptbl_EW_results = tbl_result_ew,
                             ps_path_tbl_save = s_path_extracted_results,
                             ps_scenario = s_scenario,
                             ps_marketchannel = s_marketingchannel,
                             ps_input_genetic_SD = s_input_genetic_SD,
                             pb_log = b_log)
```

