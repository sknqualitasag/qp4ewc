---
title: "Manual EWDC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(qp4ewc)
```

# Aim

In this vignette, you will get more information about the construction of the main-functions `pre_process_ew_input()` and `post_process_ewdc_output`. 
The task of `pre_process_ew_input()` is to pre-process the input-parameter-files for ECOWEIGHT specific for dairy cattle (EWDC).
Whereas the task of `post_process_ewdc_output` is to extract from the result file of ECOWEIGHT specific for dairy cattle economic weights and population means for a specific scenario.

# Pre-processing part

Major steps of `pre_process_ew_input()` are 

 1) function `create_directory_scenario()` : create directory per scenario with input-parameter-file for ECOWEIGHT. Details in the vignette Explain the function create_directory_scenario().
 
 2) Read file with input from literature research and update input-parameter-file coming from literature of ECOWEIGHT. Details in the vignette Explain the part only from literature. Next to the literature some initial parameter need to be set for EWDC (ECOWEIGHT Dairy Cattle). Further depending of the 
 * `s_sirebreed` and `s_dambreed` some values for maturity type of progeny are set, 

 3) function `pre_process_ew_input_calving()` : Pre-processing the calving data for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ew_input_calving().
 
 4) function `pre_process_ewdc_input_progeny_data_flp()` : Pre-processing the progeny data flp for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ewdc_input_progeny_data_flp(). 
 
 5) function `pre_process_ew_input_carcass_data_flp()` : Pre-processing the carcass conformation, fat, prices based on flp-data for input-parameter-file of ECOWEIGHT. Details in the vignette Explain the function pre_process_ew_input_carcass_data_flp().


## Parameters 

```{r}
# Sire breed can be: AN,AU,CH,LM,OB,SI corresponding to Angus,Aubrac, Charolais, Limousin, Original-Braunvieh, Simmental
s_sirebreed <- "LM"
# Dam breed can be for beef-on-dairy: HO,BS corresponding to Holstein or Brown Swiss (+Braunvieh) 
s_dambreed <- "HO"
# Production system according to ECOWEIGHT for beef-on-dairy: 4 corresponding to dairy
s_prodsystem <- "4"
# Marketing channel can be: ConventionalBeef, ConventionalVeal, Export corresponding to intensive fattening system for beef or veal or all crossbred calves being sold as calves to the handler
s_marketingchannel <- "ConventionalBeef"
# Path to define from the working directory for beef-on-dairy
s_path_directory2create <- file.path(here::here(),"inst","extdata","ewdc","test","Ecoweight_output")
# Path to input from the literature research. Based on this example an other file can be created with different input-value and input-source.
s_input_file_literature <- system.file("extdata","ewdc",paste0("input_literature_",s_dambreed,"_",s_marketingchannel,".txt"), package = "qp4ewc")
# Path to input from the parameter specific for the scenario. Based on this example an other file can be created with different input-value.
s_input_file_par <- system.file("extdata","ewdc","input_par_statement.txt", package = "qp4ewc")
# path to file with input for file 35 for the input-parameter-file for ECOWEIGHT
s_input_file_35 <- system.file("extdata","ewbc","input35_statement.txt", package = "qp4ewc")
# path to file with input for file 36 for the input-parameter-file for ECOWEIGHT
s_input_file_36 <- system.file("extdata","ewbc","input36_statement.txt", package = "qp4ewc")
# Path to specific input for ProdSyst1 for tested bulls (this is only for beef-on-beef needed)
s_input_file_testedbulls <- system.file("extdata","ewbc","input_testedbulls.txt", package = "qp4ewc")
# Path to specific input for ProdSyst3 for replacement progeny heifers (this is only for beef-on-beef needed)
s_input_file_purchasedreplacementheifers  <- system.file("extdata","ewbc","input_purchasedreplacementheifers.txt", package = "qp4ewc")
# Path to input from the calving. Based on this example an other file can be created with different input-values.
s_input_file_calving_statement <- system.file("extdata","ewdc","input_calving_statement.txt", package = "qp4ewc")
# Path to calving data file
s_input_file_calving <- system.file("extdata","ewdc","test","test_zws_muku_gal.csv", package = "qp4ewc")
# Date YYYYMMDD used as start date to filter data for calving or carcass
s_start_date <- 20160101
# Date YYYYMMDD used as end date to filter data for calving or carcass
s_end_date <- 20211231
# Path to input from the progeny flp data. Based on this example an other file can be created with different input-values.
s_input_file_progeny_flp_statement <- system.file("extdata","ewdc","input_flp_statement.txt", package = "qp4ewc")
# Path to flp data file
s_input_file_flp <- system.file("extdata","ewdc","test","test_zws_muku_flp.csv", package = "qp4ewc")
# Path to calf price data file.
s_input_file_calf <- system.file("extdata","ewdc","test","test_calf_data.csv", package = "qp4ewc")
# Path to input statement for carcass and price
s_input_file_flp_carcass_matrix_statement <- system.file("extdata","ewdc","input_flp_carcass_matrix_statement.txt", package = "qp4ewc")
# Path to input with cow price. Based on this example an other file can be created with different input-values.
s_input_file_price_cow <- system.file("extdata","ewdc","cow_price.txt", package = "qp4ewc")
# Path to input with bull price. Based on this example an other file can be created with different input-values.
s_input_file_price_bull <- system.file("extdata","ewdc","bull_price.txt", package = "qp4ewc")
# Path to input with heifer price. Based on this example an other file can be created with different input-values.
s_input_file_price_heifer <- system.file("extdata","ewdc","heifer_price.txt", package = "qp4ewc")
# Path to input with calf price. Based on this example an other file can be created with different input-values
s_input_file_price_calf <- system.file("extdata","ewdc","veal_price.txt", package = "qp4ewc")
# Path to pedigree input file
s_input_file_ped <- system.file("extdata","ewdc","test","test_pedigree.txt", package = "qp4ewc")
# Flag to set to TRUE, if a log-file is whished
b_log <- TRUE
```

At the beginning of the function depending of the setting for `pb_log` and `plogger`, a log-file will be created.


## Run pre_process_ew_input() in RStudio

```{r, warning=FALSE, message=FALSE}
pre_process_ew_input(ps_sirebreed = s_sirebreed,
                     ps_dambreed = s_dambreed,
                     ps_prodsystew = s_prodsystem,
                     ps_marketchannel = s_marketingchannel,
                     ps_path_directory2create = s_path_directory2create,
                     ps_input_file_literature = s_input_file_literature,
                     ps_input_file_par = s_input_file_par,
                     ps_input_file_35 = s_input_file_35,
                     ps_input_file_36 = s_input_file_36,
                     ps_input_file_testedbulls = s_input_file_testedbulls,
                     ps_input_file_purchasedreplacementheifers = s_input_file_purchasedreplacementheifers,
                     ps_input_file_calving_statement = s_input_file_calving_statement,
                     ps_input_file_calving = s_input_file_calving,
                     ps_start_date = s_start_date,
                     ps_end_date = s_end_date,
                     ps_input_file_progeny_flp_statement = s_input_file_progeny_flp_statement,
                     ps_input_file_flp = s_input_file_flp,
                     ps_input_file_calf = s_input_file_calf,
                     ps_input_file_flp_carcass_matrix_statement = s_input_file_flp_carcass_matrix_statement,
                     ps_input_file_price_cow = s_input_file_price_cow,
                     ps_input_file_price_bull = s_input_file_price_bull,
                     ps_input_file_price_heifer = s_input_file_price_heifer,
                     ps_input_file_price_calf = s_input_file_price_calf,
                     ps_input_file_ped = s_input_file_ped,
                     pb_log = b_log)
```

The input-files are now ready to execute ECOWEIGHT for dairy cattle (EWDC). This need to be done separately and is not part of the package qp4ewc.
As soon as we have the result file of ECOWEIGHT for dairy cattle, we can run the post-processing part to extract economic weights and population means.

# Post-processing part

The major step of `post_process_ewdc_output` is to read output file from ECOWEIGHT and makes single table with piechart per scenario. 
More details to this step is in the vignette number 6.

Because numerous scenari can be calculated, in the vignette number 7, you can find an extra function how to sort by sirebreed or dambreed or marketing channel to facilitate the interpretation of the results.

## Parameters

To show how `post_process_ewdc_output` is build, we made some test-file from ECOWEIGHT (EWDC).

```{r}
#Path to file
s_path_2outputfile <- system.file("extdata","ewdc","Ecoweight_output",
                                  paste0(s_sirebreed,"_",s_dambreed, "_",s_prodsystem,"_",s_marketingchannel,"_test",collapse = ""),
                                  "test",package = "qp4ewc")
# Path to output statements from the results file of ewdc
s_output_statement <-  system.file("extdata","ewdc","output_statement.txt", package = "qp4ewc")
# Path to search patterns needed to find correct results 
s_output_search_pattern <- system.file("extdata","ewdc","output_searchpattern.txt", package = "qp4ewc")
# Path to genetic standard deviation values 
s_input_genetic_SD <- system.file("extdata","ewdc","input_geneticSD.txt", package = "qp4ewc")
# Scenario
s_scenario <- paste0(s_sirebreed,"_",s_dambreed, "_",s_prodsystem,"_",s_marketingchannel,"_test",collapse = "")
# Path to save table of result 
s_path_extracted_results <- file.path(here::here(),"inst", "extdata", "ewdc", "results")
```

```{r, warning=FALSE, message=FALSE}
post_process_output(ps_path_2outputfile = s_path_2outputfile,
                    ps_output_statement = s_output_statement,
                    ps_output_search_pattern = s_output_search_pattern,
                    ps_sirebreed = s_sirebreed,
                    ps_dambreed = s_dambreed,
                    ps_prodsystem = s_prodsystem,
                    ps_marketchannel = s_marketingchannel,
                    ps_path_directory2create = s_path_directory2create,
                    ps_scenario = s_scenario,
                    ps_path_tbl_save = s_path_extracted_results,
                    ps_input_genetic_SD = s_input_genetic_SD,
                    pb_log = b_log)
```
